<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ’¬ UChat Offline</title>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
header{background:#4a90e2;color:#fff;padding:12px;display:flex;justify-content:space-between;align-items:center}
#logout{background:#ff4d4d;color:#fff;border:none;padding:6px 10px;border-radius:6px}

#chat{height:calc(100vh - 200px);overflow-y:auto;padding:10px}
.msg{background:#fff;padding:10px;margin:6px 0;border-radius:14px;max-width:70%;position:relative}
.me{background:#d9ecff;margin-left:auto}
.name{font-size:13px;color:#4a90e2;font-weight:bold}
.time{font-size:11px;color:#888;text-align:right}
.action{font-size:12px;color:#4a90e2;cursor:pointer}
.recall{font-style:italic;color:#999}

.reactions{margin-top:4px;font-size:18px}
.reactions span{margin-right:6px}

.reactionBox{
  position:absolute;
  bottom:100%;
  left:10px;
  background:#fff;
  border-radius:30px;
  padding:6px 10px;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
  display:none;
  gap:10px;
  z-index:99;
}
.reactionBox span{font-size:22px;cursor:pointer}

#inputBox{padding:10px;background:#fff;display:flex;gap:5px}
input{flex:1;padding:10px;font-size:16px}
button{padding:10px;font-size:16px}

#loginBox{text-align:center;padding:30px}
</style>
</head>

<body>

<header>
ğŸ’¬ <b>UChat Offline</b>
<button id="logout" onclick="logout()">ğŸšª</button>
</header>

<div id="loginBox">
<input id="username" placeholder="ğŸ‘¤ Nháº­p tÃªn"><br><br>
<button onclick="login()">VÃ o chat</button>
</div>

<div id="chat" style="display:none"></div>

<div id="inputBox" style="display:none">
<input id="text" placeholder="âœï¸ Nháº­p tin nháº¯n">
<button onclick="send()">ğŸ“¤</button>
</div>

<script>
let user="";
let messages=JSON.parse(localStorage.getItem("chat_data")||"[]");
const chat=document.getElementById("chat");

if(localStorage.chat_user){
  user=localStorage.chat_user;
  start();
}

function login(){
  user=username.value.trim();
  if(!user) return alert("Nháº­p tÃªn");
  localStorage.chat_user=user;
  start();
}

function start(){
  loginBox.style.display="none";
  chat.style.display="block";
  inputBox.style.display="flex";
  render();
}

function logout(){
  localStorage.clear();
  location.reload();
}

function save(){
  localStorage.setItem("chat_data",JSON.stringify(messages));
}

function send(){
  const t=text.value.trim();
  if(!t) return;
  messages.push({
    id:Date.now(),
    name:user,
    msg:t,
    time:new Date().toLocaleTimeString(),
    recall:false,
    react:{}
  });
  text.value="";
  save();render();
}

function render(){
  chat.innerHTML="";
  messages.forEach(m=>{
    const div=document.createElement("div");
    div.className="msg"+(m.name===user?" me":"");
    div.onclick=()=>toggleReactBox(m.id);

    div.innerHTML=`
      <div class="reactionBox" id="box${m.id}">
        <span onclick="addReact(event,${m.id},'ğŸ˜€')">ğŸ˜€</span>
        <span onclick="addReact(event,${m.id},'ğŸ˜')">ğŸ˜</span>
        <span onclick="addReact(event,${m.id},'â¤ï¸')">â¤ï¸</span>
        <span onclick="addReact(event,${m.id},'ğŸ‘')">ğŸ‘</span>
        <span onclick="addReact(event,${m.id},'ğŸ–')">ğŸ–</span>
        <span onclick="addReact(event,${m.id},'ğŸ˜‡')">ğŸ˜‡</span>
        <span onclick="addReact(event,${m.id},'ğŸ˜¡')">ğŸ˜¡</span>
      </div>

      <div class="name">${m.name}</div>
      <div>${m.recall?'<span class="recall">Tin nháº¯n Ä‘Ã£ thu há»“i</span>':m.msg}</div>

      <div class="reactions">
        ${Object.keys(m.react).map(e=>`${e} ${m.react[e]}`).join(" ")}
      </div>

      <div class="time">${m.time}</div>

      ${m.name===user?`
        <div class="action" onclick="editMsg(event,${m.id})">âœï¸ Sá»­a</div>
        <div class="action" onclick="recallMsg(event,${m.id})">â™»ï¸ Thu há»“i</div>
      `:""}
    `;
    chat.appendChild(div);
  });
  chat.scrollTop=chat.scrollHeight;
}

function toggleReactBox(id){
  document.querySelectorAll(".reactionBox").forEach(b=>b.style.display="none");
  const box=document.getElementById("box"+id);
  box.style.display="flex";
}

function addReact(e,id,emoji){
  e.stopPropagation();
  const m=messages.find(x=>x.id===id);
  m.react[emoji]=(m.react[emoji]||0)+1;
  save();render();
}

function editMsg(e,id){
  e.stopPropagation();
  const m=messages.find(x=>x.id===id);
  const n=prompt("Sá»­a:",m.msg);
  if(n){m.msg=n+" (Ä‘Ã£ sá»­a)";save();render();}
}

function recallMsg(e,id){
  e.stopPropagation();
  const m=messages.find(x=>x.id===id);
  if(confirm("Thu há»“i?")){m.recall=true;save();render();}
}
</script>

</body>
</html>
